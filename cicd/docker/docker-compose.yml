version: '3.8'

services:
  # Nginx 리버스 프록시 서버
  nginx:
    image: nginx:alpine    # 경량화된 Nginx 이미지 사용
    ports:
      - "80:80"           # HTTP 포트
      - "443:443"         # HTTPS 포트
    volumes:
      - ../config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /data/certs:/etc/nginx/certs:ro
      - /data/logs/nginx:/var/log/nginx
    depends_on:
      - gitlab
      - jenkins
      - harbor
    networks:
      loadbalancer_net:
        ipv4_address: 172.16.10.10
      internal_net:
        aliases:
          - nginx.cicd.local
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # GitLab 소스 코드 관리 서버
  gitlab:
    image: gitlab/gitlab-ce:latest
    hostname: gitlab.local
    environment:
      # GitLab 기본 설정
      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_EXTERNAL_URL:-https://gitlab.local}'
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT:-2222}
        gitlab_rails['initial_root_password'] = '${GITLAB_ROOT_PASSWORD}'
    ports:
      - "2222:22"
    volumes:
      - ${GITLAB_HOME:-/data/gitlab}/config:/etc/gitlab
      - ${GITLAB_HOME:-/data/gitlab}/logs:/var/log/gitlab
      - ${GITLAB_HOME:-/data/gitlab}/data:/var/opt/gitlab
    networks:
      internal_net:
        aliases:
          - gitlab.cicd.local
    expose:
      - "80"
      - "22"
    healthcheck:
      test: ["CMD", "/opt/gitlab/bin/gitlab-healthcheck", "--fail"]
      interval: 60s
      timeout: 30s
      retries: 3
    security_opt:
      - no-new-privileges:true
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # GitLab CI 실행기
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    volumes:
      - /data/gitlab/runner:/etc/gitlab-runner      # Runner 설정
      - /var/run/docker.sock:/var/run/docker.sock   # Docker 소켓 마운트
    networks:
      - cicd_network

  # Jenkins CI/CD 서버
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    user: root  # Docker 소켓 접근을 위해 필요
    ports:
      - "8080:8080"
    environment:
      # Jenkins 환경 설정
      - JENKINS_ADMIN_ID=${JENKINS_ADMIN_ID:-admin}
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD}
      - JENKINS_OPTS="--prefix=/jenkins --httpsKeyStore=/var/jenkins_home/keystore.jks"
      # JVM 메모리 설정
      - JAVA_OPTS="-Xmx2g -Xms512m -XX:MaxMetaspaceSize=512m"
    volumes:
      - ${JENKINS_HOME:-/data/jenkins}:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      internal_net:
        aliases:
          - jenkins.cicd.local
    expose:
      - "8080"
      - "50000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/jenkins"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # Harbor 컨테이너 레지스트리
  harbor:
    image: goharbor/harbor-core:v2.8.0
    env_file:
      - ../.env    # Harbor 환경변수 파일
    depends_on:
      - harbor-db
      - harbor-redis
    volumes:
      - /data/harbor/core:/data
      - /data/harbor/config:/etc/harbor
      - /data/certs:/etc/harbor/ssl:ro
    environment:
      - HARBOR_PROTOCOL=https
      - HARBOR_ADMIN_PASSWORD=${HARBOR_ADMIN_PASSWORD}
      - HARBOR_DB_PASSWORD=${HARBOR_DB_PASSWORD}
      - CORE_SECRET=${HARBOR_SECRET_KEY}
    ports:
      - "443:443"
      - "4443:4443"
    networks:
      internal_net:
        aliases:
          - harbor.cicd.local
      loadbalancer_net:   # Harbor는 외부 접근 필요
    expose:
      - "443"
      - "4443"
      - "8080"
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v2.0/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  harbor-db:
    image: goharbor/harbor-db:v2.8.0
    volumes:
      - /data/harbor/database:/var/lib/postgresql/data
    networks:
      internal_net:
        aliases:
          - harbor-db.cicd.local

  harbor-redis:
    image: goharbor/harbor-redis:v2.8.0
    volumes:
      - /data/harbor/redis:/var/lib/redis
    networks:
      internal_net:
        aliases:
          - harbor-redis.cicd.local

  harbor-registry:
    image: goharbor/harbor-registry-photon:v2.8.0
    volumes:
      - /data/harbor/registry:/storage
      - /data/certs:/etc/harbor/ssl:ro
    environment:
      - REGISTRY_HTTP_TLS_CERTIFICATE=/etc/harbor/ssl/harbor.local.crt
      - REGISTRY_HTTP_TLS_KEY=/etc/harbor/ssl/harbor.local.key
    networks:
      internal_net:
        aliases:
          - harbor-registry.cicd.local

networks:
  loadbalancer_net:
    external: true    # HAProxy 연결용 외부 네트워크
    name: loadbalancer_net
  internal_net:
    driver: bridge
    internal: true    # 내부 서비스 통신용
    ipam:
      config:
        - subnet: 172.20.10.0/24
    driver_opts:
      com.docker.network.bridge.name: cicd_internal
