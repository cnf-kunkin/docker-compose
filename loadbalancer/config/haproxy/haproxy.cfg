global
    # 사용자 설정
    user haproxy
    group haproxy
    
    # chroot 설정
    chroot /var/lib/haproxy
    
    # 데몬 설정
    daemon
    master-worker
    
    # 프로세스 관리
    nbproc 1
    maxconn 50000
    
    # 로그 설정
    log /dev/log local0
    log /dev/log local1 notice
    
    # SSL 설정
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    
    # 상태 소켓 설정
    stats socket /var/run/haproxy/admin.sock mode 660 level admin expose-fd listeners

defaults
    log global
    mode http
    option dontlognull
    option forwardfor
    
    # 타임아웃 설정
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    
    # 로그 포맷 설정
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

frontend http-in
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/haproxy.pem
    
    # DDOS 방어 설정
    stick-table type ip size 100k expire 30s store conn_cur
    tcp-request connection track-sc1 src
    tcp-request connection reject if { sc1_conn_cur gt 100 }
    
    # SSL/TLS 보안 설정
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request redirect scheme https code 301 unless { ssl_fc }
    
    # 보안 헤더 추가
    http-response set-header Strict-Transport-Security "max-age=31536000"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    
    # CICD Services
    acl host_gitlab hdr(host) -i gitlab.local
    acl host_jenkins hdr(host) -i jenkins.local
    acl host_harbor hdr(host) -i harbor.local

    # Monitoring Services
    acl host_grafana hdr(host) -i grafana.local
    acl host_prometheus hdr(host) -i prometheus.local

    # Security Services
    acl host_sonarqube hdr(host) -i sonarqube.local
    acl host_security hdr(host) -i security.local

    # Application Services
    acl host_next hdr(host) -i next-demo.local
    acl host_nest hdr(host) -i nest-demo.local
    acl host_python hdr(host) -i python-demo.local

    # Backend Selection
    use_backend cicd-gitlab if host_gitlab
    use_backend cicd-jenkins if host_jenkins
    use_backend cicd-harbor if host_harbor
    use_backend mon-grafana if host_grafana
    use_backend mon-prometheus if host_prometheus
    use_backend sec-sonarqube if host_sonarqube
    use_backend sec-security if host_security
    use_backend app-next if host_next
    use_backend app-nest if host_nest
    use_backend app-python if host_python

# Backend definitions
backend cicd-gitlab
    server gitlab 172.16.10.10:80

backend cicd-jenkins
    server jenkins 172.16.10.10:8080

backend cicd-harbor
    server harbor 172.16.10.10:8443

backend mon-grafana
    server grafana 172.16.10.20:3000

backend mon-prometheus
    server prometheus 172.16.10.20:9090

backend sec-sonarqube
    server sonarqube 172.16.10.30:9000

backend sec-security
    server security 172.16.10.30:8080

backend app-next
    server next 172.16.10.40:3000

backend app-nest
    server nest 172.16.10.40:3001

backend app-python
    server python 172.16.10.40:8000

# 상태 모니터링 설정
listen stats
    bind *:8404 ssl crt /etc/ssl/certs/haproxy.local.pem
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth ${STATS_USER}:${STATS_PASSWORD}  # 환경변수에서 설정한 값 사용
    stats hide-version
    stats admin if TRUE
